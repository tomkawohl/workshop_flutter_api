# WORKSHOP_API

## C'est quoi une api

- **Api** veut dire Application programming interface (interface de programmation d‚Äôapplication en fran√ßais).
- L‚Äôapi permet d‚Äôacc√©der √† des services (donn√©es ou fonctionnalit√©s) d‚Äôun syst√®me tiers.
Cela permet de faire dialoguer facilement des applications.
La plupart des API sont des api serveurs.
Une api est accessible √† partir d‚Äôune adresse √† laquelle on va faire des requ√™tes.

###¬†Exemple:

Le front (affichage) d‚Äôun site web est **consommateur du service**. Il utilise l‚Äôapi qui est **producteur du service**.
Le front peut-√™tre l‚Äôaffichage d‚Äôune boutique de chaussures, elle demande √† l‚Äôapi quels chaussures sont en vente, l‚Äôapi envoie au front ces informations avec un titre, une description, un prix.
On utilise souvent le format json pour envoyer et recevoir des donn√©es avec des api:

https://www.lemondeinformatique.fr/actualites/lire-focus-sur-json-le-format-star-des-echanges-de-donnees-76951.html

``` json
"response": {
        "shoes": [
          {
            "title": "Chaussures de sport",
            "description": "Confortables et l√©g√®res pour la course.",
            "price": "79.99"
          },
          {
            "title": "Chaussures habill√©es",
            "description": "√âl√©gantes pour les occasions formelles.",
            "price": "149.99"
          }
        ]
      }
```

Ou encore
Une api propose l‚Äôutilisation d‚Äôune ia qui va indiquer si un commentaire est positif ou n√©gatif
On envoie √† l‚Äôapi:
``` json
"data": {
          "comment": "J'adore ce produit, il est vraiment fantastique!"
        }
```
L'api r√©pond
``` json
"response": {
        "sentiment": "positif",
        "confidence": 0.98
      }
    }
```

##¬†Objectif

Faire une api avec express pour une application mobile.

## Configuration du projet

Suivez les √©tapes du README pour configurer le projet.
L‚Äôapplication doit se lancer sur l‚Äô√©cran pour s‚Äôenregistrer et se connecter.
Et la base de donn√©es doit √™tre lanc√©e avec docker.

## D√©velopper l‚ÄôAPI:


**1 Aller dans le dossier API**

``` sh
cd API
```

**2 Initialiser le projet**
``` sh
npm init -y
```

**npm:**
"Node Package Manager", est un gestionnaire de paquets pour Node.js. Il est utilis√© pour g√©rer les d√©pendances de projets JavaScript, permettant aux d√©veloppeurs de partager et de r√©utiliser du code

**3 Installer express**
``` sh
npm install express
``` 

**express** est un framework pour Node.js qui permet de cr√©er une api facilement.

Vous constater que cela a cr√©er un package.json. cat package.json pour plus d‚Äôinformations.
vous pouvez rajouter la ligne ‚Äústart‚Äù ici, √ßa lancera votre api avec npm start. √áa lancera simplement votre fichier app.js
`
"scripts": {
"start": "node app.js"
},
`

**4 Ajouter le fichier principal de l‚Äôapi**
``` sh
touch app.js
```
Je vais vous montrer comment faire une api basique, vous pouvez essayer de sauter des √©tapes ou faire plus simple si cela vous dit.

**5 Configurer l‚Äôapi**
L‚Äôapi se lancera √† partir de l‚Äôadresse de la machine. Si vous la lancez depuis votre ordinateur, vous pouvez y acc√©der localement via http://localhost
Vous devez renseigner sur quel port l‚Äôapi √©coute. On va choisir le port 8080.

On ajoute d‚Äôabord express
``` javascript
const express = require('express');
```

Notre app utilise express, on renseigne le port, on ajoute une route ‚Äò/‚Äô qui d√©signe la page principal de notre api avec la m√©thode get.
Enfin l‚Äôapp √©coute sur le port.

Il existe plusieurs m√©thode pour effectuer des requ√™tes api ‚Äúget, post, put, delete‚Äù
``` javascript
const app = express();
const port = 8080;

app.get('/', (req, res) => {
res.send('Hello World!');
});

app.listen(port, () => {
console.log(`App listening at http://localhost:${port}`);
});
```

Vous pouvez lancer votre application et aller √†
npm start ->
http://localhost:8080
Vous avez cr√©er la route ‚Äò/‚Äô
√Ä partir de l√†, vous pouvez faire toutes les routes de votre application et mettre la logique √† l‚Äôint√©rieur pour cr√©er des utilisateurs ou se connecter ou autre. Mais on peut faire √ßa proprement.

**5 - 2 vous devez aussi intaller et ajouter √ßa (je l'explique pas ici vous pouvez regarder pourquoi sur internet)**
``` sh
npm install cors
```
``` javascript
const cors = require('cors');

app.use(cors());
app.use(express.json());
```

### M√©thode propre:
On veut stocker les informations proprement
Mettre les informations de configuration dans un fichier .env
Il permet de s√©parer la configuration du code source. Cela inclut des informations sensibles ou sp√©cifiques √† l'environnement, telles que les cl√©s API, les configurations de base de donn√©es, et les ports.
Un fichier .env se garde et se partage en local car il peut contenir des informations sensibles.

Vous pouvez reprendre le .env que j‚Äôai mit au root.
On y voit le port utilis√©, les informations pour se connecter √† la base de donn√©e, un ‚ÄúACCESS_TOKEN_SECRET‚Äù qui permet d‚Äôencrypter les mots de passes et une cl√© api pour utiliser TMDB. Vous pouvez rentrer votre cl√© api TMDB ici.

On utilisera dotenv pour charger ces variables:
``` javascript
npm install dotenv
require('dotenv').config({
path: `./.env`
});


const port = process.env.PORT;
```

### M√©thode crado ü§Æ
Utiliser les variables en dur dans le code:
const port = 8080



**6 Ajouter d‚Äôautres routes:**

### M√©thode propre:
On va utiliser un router et des middlewares.
Le router va g√©rer les routes.
Un Middleware est une fonction qui a acc√®s √† l'objet de requ√™te (req), l'objet de r√©ponse (res), et √† la fonction next dans le cycle de requ√™te-r√©ponse d'une application Express.js. Chaque middleware peut ex√©cuter du code, modifier les objets de requ√™te et de r√©ponse, terminer le cycle de requ√™te-r√©ponse, ou appeler la fonction next pour passer le contr√¥le au middleware suivant.

Il va traiter et v√©rifier si la requ√™te peut aboutir.

Par exemple il peut v√©rifier si un utilisateur est bien authentifier avant de faire une requ√™te.

Pour cr√©er les routes:
``` sh
mkdir routes &&
touch routes/index.js
```

Dans index.js
``` javascript

const express = require('express');

const router = express.Router();

const { wrap } = require('async-middleware');
```

On utiliser le router, et wrap va envelopper les fonctions √† faire pour les routes, il traitera la requ√™te et doit g√©rer les cas d‚Äôerreurs.
On va faire les fonctions plus tard mais voici comment ajouter une  route:
``` javascript

router.post('/register', wrap(checkUsername), wrap(createAccount));
```

Pour cr√©er un compte
On v√©rifie l‚Äôusername puis on cr√©er un compte, si l‚Äôusername n‚Äôest pas valide, √ßa ne cr√©era pas de compte.
Il faut exporter le router 
module.exports = router;

et l‚Äôajouter dans app.js
``` javascript

const indexRouter = require('./routes/index');

app.use('/', indexRouter);
```


###¬†M√©thode crado ü§Æ
Mettre les routes en dur avec l‚Äôapp comme on a fait pour afficher ‚ÄúHello Worl‚Äù

**7 Ajouter de la logique**

On va vouloir communiquer avec notre base de donn√©e, c‚Äôest une base de donn√©e en PostGreSQL.
Cr√©er un dossier database qui servira la logique pour int√©ragir avec la database et un dossier features_user qui servira la logique pour les fonctionnalit√©s des utilisateurs. Cr√©er un dossier register dans features_user. Cr√©er un dossier middlewares. Puis cr√©er les fichiers.js √† l‚Äôint√©rieur.

On va cr√©er un fichier congig.js dans database qui va nous permettre de nous connecter √† la base de donn√©es.
Voici un exemple d‚Äôarchitecture:
![architecture](./architecture.png)

Pour se connecter √† la base de donn√©e (database/config.js)
``` javascript
require('dotenv').config({
path: `./.env`
});

let connectionParams = {
host: process.env.DB_HOST,
user: process.env.DB_USER,
password: process.env.DB_PASSWORD,
database: process.env.DB_NAME,
port: process.env.DB_PORT
};

if (process.env.DB_URL) {
connectionParams = {
connectionString: process.env.DB_URL
}
}

module.exports = connectionParams;
```


Dans les fichiers qui ont en ont besoin, on utilisera:
``` sh
npm install pg
```

``` javascript

const { Pool } = require('pg');
const config = require('../../database/config');

const pool = new Pool(config);
```

Pool est un outil pour se connecter √† une base de donn√©e PostGreSQL.

Vous n‚Äô√™tes pas oblig√© de faire checkUsername, checkUsername v√©rifiera si le nom d‚Äôutilisateur est d√©j√† prit en base de donn√©es. Exemple:
checkUsername.js
``` javascript

const { isUsernameTaken } = require("../../database/users/usernameIsTaken");

async function checkUsername(req, res, next) {
if (await isUsernameTaken(req.body.username)) {
return res.status(400).json({ error: 'Username is already taken' });
}
next();
}

module.exports = checkUsername;
```


isUsernameTaken.js
``` javascript

const { Pool } = require('pg');
const config = require('../../database/config');

const pool = new Pool(config);

async function isUsernameTaken(username) {
return new Promise((resolve, reject) => {
pool.query(
`
SELECT 1 FROM users WHERE username = $1
`,
[username],
(error, result) => {
if (error) {
reject(error);
} else {
resolve(result.rowCount > 0);
}
}
)
});
}

module.exports = {
isUsernameTaken
};
```

Voici la fonction pour cr√©er un utilisateur dans features_user:
``` javascript

const { createUser } = require('../../database/users/createUser');

async function createAccount(req, res) {
const { username, password } = req.body;

const user = await createUser({ username, password });

console.log(`User ${user} created`);

return res.status(201).json({
user
});
}

module.exports = createAccount;
```

Voici la fonction pour cr√©er un utilisateur en base de donn√©e, on encrypt le mot de passe et on renvoie en r√©ponse le nom de l‚Äôutilisateur.
npm install bcrypt
``` javascript

const bcrypt = require('bcrypt');

const { Pool } = require('pg');
const config = require('../../database/config');

const pool = new Pool(config);

async function createUser({
username, password
}) {
const hashedPass = await bcrypt.hash(password, 7);
return new Promise((resolve, reject) => {
pool.query(
`
INSERT INTO users
(username, password)
SELECT $1, $2
RETURNING username
`,
[username, hashedPass],
async (error, result) => {
if (error) {
reject(error);
} else {
resolve(result.rows[0].username);
}
}
)
})
}

module.exports = {
createUser
};
```


Vous pouvez tester cette route avec Postman ou l‚Äôapplication mobile.
Cette route pour se register utilise la m√©thode post. Elle va lire le ‚Äúbody‚Äù de la requ√™te pour r√©cup√©rer un username et un password et retourne en r√©ponse le nom d‚Äôutilisateur.

On retourne une response et un code pour indiquer le status de la requ√™te. En exemple une requ√™te 403 indique que la requ√™te n‚Äôest pas autoris√©, vous pouvez vous renseigner sur les diff√©rents type de retours.


##¬†M√©thode crado ü§Æ<br>
Tout mettre dans une fonction dans la route.


**8 Continuer √† faire des routes**<br>
Pour continuer, vous devez ajouter des fonctions pour int√©ragir avec la base de donn√©e. Puis cr√©er des fonctions de logique qui vont traiter les requ√™tes, puis cr√©er des middlewares qui v√©rifie l‚Äôavanc√© de la requ√™te, et enfin ajouter tout √ßa dans une route.
Vous pouvez regarder dans le code de l‚Äôapplication pour vous aider √† faire les routes, chercher avec ApiClient().post ou ApiClient().get
**Exemple:**
``` dart

void _login() async {
var data = {
'username': _usernameController.text,
'password': _passwordController.text,
};

try {
final response = await ApiClient().postRequest(
'/login',
data,
);

if (response.statusCode == 200) {
ApiClient().token = response.data['token'];
ApiClient().userId = response.data['id'];
if (mounted) {
_showMessage('Connexion r√©ussie', Colors.green);
}
if (mounted) Navigator.push(context, MaterialPageRoute(builder: (context) => const HomeScreen()));
} else {
if (mounted) {
_showMessage('Nom d\'utilisateur ou mot de passe incorrect', Colors.red);
}
}
} catch (e) {
if (mounted) {
_showMessage('Erreur de connexion', Colors.red);
}
print('Error connexion: $e');
}
}
```

Ici on fait une requ√™te avec en body ‚Äòusername‚Äô et ‚Äòpassword‚Äô avec la m√©thode post √† l‚Äôadresse ‚Äòlogin‚Äô on v√©rifie le retour de l‚Äôapplication.
Il faut renvoyer un token et l‚Äôid de l‚Äôutilisateur. C‚Äôest un retour 200 √©galement quand c‚Äôest r√©ussi.

Pour vous aider:
Vous pouvez utiliser jsonwebtoken
npm install jsonwebtoken

pour g√©n√©rer un token: r√©cup√©rer la premi√®re ligne de openssl rand -base64 64
et metter l√† dans le .env √† ACCESS_TOKEN_SECRET

``` javascript
const jwt = require('jsonwebtoken');
const { getUser } = require('../../database/users/getUser');
const bcrypt = require('bcrypt');
const { Pool } = require('pg');
const config = require('../../database/config');

const pool = new Pool(config);

async function login(req, res) {
const { username, password } = req.body;

const user = await getUser(username);

if (!user || !await bcrypt.compare(password, user.password)) {
return res.status(401).json({ error: 'Invalid username or password' });
}
console.log('User connected: ', user.username);
return res.status(200).json({
id: user.id,
username: user.username,
token: jwt.sign({ username: user.username, id: user.id }, process.env.ACCESS_TOKEN_SECRET, { expiresIn: '1h' })
});
}

module.exports = login;
```


**9 Int√©grer TMDB:**<br>
Vous pouvez faire des calls api dans votre api.
On r√©cup√®re la cl√©, on regarde la documentation de l‚Äôapi de TMDB et on fait les requ√™tes
``` javascript
const TMDB_API_KEY = process.env.TMDB_API_KEY;

async function getMovieDetails(tmdbId) {
const url = `https://api.themoviedb.org/3/movie/${tmdbId}?api_key=${TMDB_API_KEY}`;
try {
const response = await axios.get(url);
return response.data;
} catch (error) {
console.error(`Error fetching movie details for TMDB ID ${tmdbId}:`, error);
throw error;
}
}
```

Vous pouvez ajouter des fonctionnalit√©s compl√©mentaires, par exemple ajouter des amis, il y a une table friendship en db.
